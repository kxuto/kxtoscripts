local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Player = Players.LocalPlayer

-- Utility functions
local function GetCharacter()
    return Player.Character or Player.CharacterAdded:Wait()
end

local function GetHumanoid()
    return GetCharacter():FindFirstChildOfClass("Humanoid")
end

local function GetHRP()
    return GetCharacter():FindFirstChild("HumanoidRootPart")
end

local function ToggleControlStand(State)
    if State then
        -- Summon stand if not already out
        local Character = GetCharacter()
        local RemoteFunc = Character:FindFirstChild("RemoteFunction")
        
        if not Character:FindFirstChild("StandMorph") then
            RemoteFunc:InvokeServer("ToggleStand", "Toggle")
        end
        
        repeat task.wait() until Character:FindFirstChild("StandMorph")
        local StandMorph = Character.StandMorph
        
        -- Disable stand attach constraints for better movement
        StandMorph.PrimaryPart.StandAttach:FindFirstChild("AlignOrientation").Enabled = false
        StandMorph.PrimaryPart.StandAttach:FindFirstChild("AlignPosition").Enabled = false
        
        -- Godmode (no collision) while keeping movement
        for _, v in pairs(Character:GetDescendants()) do
            if v:IsA("BasePart") then
                v.CanCollide = false
                -- v.Anchored = false (Don't anchor - allows movement)
            end
        end
        
        -- Force camera to focus on stand
        local CameraValue = Instance.new("ObjectValue", StandMorph.Parent)
        CameraValue.Name = "FocusCam"
        CameraValue.Value = StandMorph.AnimationController
        
        -- Movement control (character follows stand underground)
        local ControlLoop
        ControlLoop = RunService.Heartbeat:Connect(function()
            if not (StandMorph and StandMorph.PrimaryPart) then return end
            
            -- Move character underground (invisibility)
            local HRP = GetHRP()
            if HRP then
                HRP.CFrame = StandMorph.PrimaryPart.CFrame - Vector3.new(0, 36, 0)
            end
            
            -- Sync movement input to stand
            local Humanoid = GetHumanoid()
            if Humanoid then
                StandMorph.AnimationController:Move(Humanoid.MoveDirection, false)
            end
        end)
        
        return function() -- Cleanup function
            ControlLoop:Disconnect()
            if CameraValue then CameraValue:Destroy() end
            RemoteFunc:InvokeServer("ToggleStand", "Toggle")
        end
    end
end

-- Toggle system
local Enabled = false
local CleanupFunc

return function()
    Enabled = not Enabled
    if CleanupFunc then CleanupFunc() end
    CleanupFunc = ToggleControlStand(Enabled)
end
